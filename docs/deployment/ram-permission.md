# 阿里云 RAM 用户权限配置详细指南

## 🎯 目标
为你的 RAM 用户添加访问私有 OSS Bucket 的权限，让代码能够正常上传和访问文件。

## 📋 准备信息
- **AccessKey ID**: your_access_key_id
- **Bucket 名称**: reface
- **需要的权限**: 读取、写入、删除文件，设置文件权限

## 🔧 详细操作步骤

### 步骤 1: 登录阿里云控制台
1. 打开浏览器，访问：https://ecs.console.aliyun.com/
2. 使用你的阿里云账号登录

### 步骤 2: 进入访问控制 (RAM) 管理
1. 在控制台顶部搜索框输入 **"RAM"**
2. 点击 **"访问控制"** 进入 RAM 控制台
3. 或直接访问：https://ram.console.aliyun.com/

### 步骤 3: 找到你的 RAM 用户
1. 在左侧菜单点击 **"用户"**
2. 在用户列表中找到 AccessKey ID 为 `your_access_key_id` 的用户
3. 点击该用户的 **"用户名"** 进入用户详情页

### 步骤 4: 添加权限策略
1. 在用户详情页，点击 **"权限管理"** 标签页
2. 点击 **"添加权限"** 按钮

### 步骤 5: 选择权限策略
有两种方式添加权限：

#### 方式一：使用系统策略（推荐，简单）
1. 在 **"选择权限"** 页面，选择 **"系统策略"**
2. 搜索并勾选以下策略：
   - `AliyunOSSFullAccess` （OSS 完全访问权限）
3. 点击 **"确定"**
4. 点击 **"完成"**

#### 方式二：创建自定义策略（更精确控制）
1. 在 **"选择权限"** 页面，选择 **"自定义策略"**
2. 如果没有合适的自定义策略，先创建一个：
   
   **创建自定义策略：**
   - 点击 **"创建权限策略"**
   - **策略名称**: `RefaceOSSAccess`
   - **配置方式**: 选择 **"脚本配置"**
   - **策略内容**: 复制以下 JSON 内容
   
   ```json
   {
     "Version": "1",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "oss:GetObject",
           "oss:PutObject",
           "oss:DeleteObject",
           "oss:GetObjectAcl",
           "oss:PutObjectAcl"
         ],
         "Resource": [
           "acs:oss:*:*:reface/*"
         ]
       },
       {
         "Effect": "Allow",
         "Action": [
           "oss:ListObjects",
           "oss:GetBucketAcl"
         ],
         "Resource": [
           "acs:oss:*:*:reface"
         ]
       }
     ]
   }
   ```
   
   - 点击 **"确定"** 创建策略
   
3. 回到用户权限页面，选择刚创建的 `RefaceOSSAccess` 策略
4. 点击 **"确定"** 和 **"完成"**

## 🔍 验证权限设置

### 方法 1: 在控制台验证
1. 回到用户详情页的 **"权限管理"** 标签页
2. 确认能看到刚添加的权限策略
3. 策略状态应该显示为 **"已生效"**

### 方法 2: 使用测试工具验证
在你的项目目录运行：
```bash
node test-with-env.js
```

如果看到类似输出，说明权限设置成功：
```
✅ 文件上传成功
✅ 文件读取成功
✅ 预签名 URL 生成成功
```

## 🚨 常见问题和解决方案

### 问题 1: 找不到用户
**原因**: AccessKey 可能在不同的阿里云账号下
**解决**: 确认你登录的是创建 AccessKey 的阿里云账号

### 问题 2: 没有权限添加策略
**原因**: 当前登录账号不是主账号或没有 RAM 管理权限
**解决**: 
- 使用主账号登录
- 或让主账号给你的子账号添加 RAM 管理权限

### 问题 3: 策略添加后仍然报错
**原因**: 权限生效需要时间，或策略配置有误
**解决**: 
- 等待 1-2 分钟后重试
- 检查策略中的 Bucket 名称是否正确（`reface`）
- 检查 Resource 路径是否正确

### 问题 4: 系统策略权限过大
**担心**: `AliyunOSSFullAccess` 权限太大
**解决**: 使用方式二创建自定义策略，只给必要的权限

## 📱 移动端操作
如果你在手机上操作：
1. 可以使用阿里云 App
2. 或在手机浏览器中访问控制台（建议使用电脑操作，界面更清晰）

## ⏰ 权限生效时间
- 通常权限添加后立即生效
- 如果仍有问题，等待 1-2 分钟后重试
- 极少数情况下可能需要 5-10 分钟

## 🎯 完成标志
当你看到以下情况时，说明配置成功：
1. ✅ 用户权限页面显示相关 OSS 策略
2. ✅ 运行测试工具不再报权限错误
3. ✅ 网站能正常上传和预览图片

## 📞 需要帮助？
如果按照步骤操作仍有问题，请告诉我：
1. 在哪一步遇到了困难
2. 看到了什么错误信息
3. 截图当前页面（如果可能）

我会进一步协助你解决！